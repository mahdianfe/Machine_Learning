# src/main.py

import sys
import os  #ุจุฑุง ฺฉุงุฑ ุจุง ูุงูโูุง ู ูุณุฑูุง
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer #ุชุจุฏู ูุชู ุจู ูฺฺฏโูุง ุนุฏุฏ
#  ุฏุฑ ูุฏู ูุงุ ุงุฒ TfidfVectorizer ุงุณุชูุงุฏู ฺฉุฑุฏู ฺฉู ูุฑุจูุท ุจู ูุชู ูุณุชุด ู
#  ููุฏุงุฑูุง ูุซู 0.32ุ 0.05ุ ... ุชููุฏ ูโฺฉูู (ุนู ุบุฑุจุงูุฑู).
from sklearn.model_selection import train_test_split #ุฌุฏุงุณุงุฒ ุฏุชุง ุจู ุชุณุช ู ุชุฑู
from sklearn.metrics import classification_report # ุงุฑุฒุงุจ ูุฏู
import joblib #ุฐุฎุฑู ูุฏู


# ุงูุฒูุฏู ูุณุฑ ุงุตู ูพุฑูฺู ุจู sys.path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
# ููุฏุงุฑ __file__ ุจุฑุงุจุฑ ุจุง ูุณุฑ ฺฉุงูู ูุงู main.py ุฎูุงูุฏ ุจูุฏ
# ุฏุฑ ูพุงุชููุ .. ฺฉ ููุงุฏ ุงุณุช ฺฉู ุจู ูพูุดูโ ูุงูุฏ (ูพูุดูโุง ฺฉู ุฏุฑ ุขู ูพูุดู ูุนู ูุฑุงุฑ ุฏุงุฑุฏ) ุงุดุงุฑู ูโฺฉูุฏ.
#  ุนู .. ุจู ุงู ูุนูุงุณุช ฺฉู ุงุฒ ูพูุดู ุฌุงุฑ ฺฉ ุณุทุญ ุจุงูุง ุจุฑู.
# ุฏุฑ ูุงูุนุ ุงู ุฎุท ุจู ูพุงุชูู ูโฺฏูุฏ ฺฉู ุงุฒ ูุณุฑ ุจุงูุงุชุฑ (ุนู project/) ุดุฑูุน ุจู ุฌุณุชุฌู ูุงฺููโูุง ฺฉูุฏุ ูู ููุท ุฏุฑ ูพูุดูโ main.py.

# ุงููพูุฑุช ฺฉุฑุฏู ูุฏูโูุง ุจู ุตูุฑุช ุฏุงูุงูฺฉ
model_name = sys.argv[1] if len(sys.argv) > 1 else "nb"  # ูพุดโูุฑุถ: Naive Bayes
#ุจุง ุงุณุชูุงุฏู ุงุฒ sys.argvุ ุงุฒ ุจุฑูู ูุงู ูู ูโุชูุงู ูุฏู ุฑุง ุชุนู ฺฉู.
#ุงู ุฎุท ุชุนู ูโฺฉูู ฺฉู ูุฏู ูพุดโูุฑุถ ฺ ุจุงุดูุ ูู ุงูฺฉู ูุฏู ูุงูุนุงู ุงููพูุฑุช ุง ุงุณุชูุงุฏู ุดุฏู ุจุงุดู ุชุง ุงูฺฉู ุจู ุฎุทูุง ุจุนุฏ ุจุฑุณู.

# ุจุฏูู ุงู ุฎุท ูุดุฏ ุจู ุตูุฑุช ุฏุณุช ูุฑ ุจุงุฑ ูุงู ูุฏู ุฑุง ูุฑุงุฑ ุจุฏู ูุซูุง
# model_name = "svm"
# ุงูุง ุฏุฑ ุงู ุตูุฑุช ููโุชูู ุงุฒ ุจุฑูู (ุนู ุงุฒ ุทุฑู ุชุฑููุงู) ูุฏู ุฑู ุชุบุฑ ุจุฏ
# ู ูุฌุจูุฑ ูโุด ูุฑ ุจุงุฑ ุจุง ุชู ูุงู main.py ู ุฏุณุช ฺฉุฏ ุฑู ุนูุถ ฺฉู.

# ุจู ุฒุจุงู ุณุงุฏู ูโฺฏูุฏ:
#     ุงฺฏู ฺฉุงุฑุจุฑ ูุฏู ุฑุง ูุงุฑุฏ ฺฉุฑุฏู (ุนู ุขุฑฺฏููุงู ุฏูู ูุฌูุฏ ุฏุงุฑุฏ)ุ ุงุฒ ุขู ุงุณุชูุงุฏู ฺฉู.
#     ูฺฏุฑููุ ูุฏู ูพุดโูุฑุถ ุฑุง ุจุฐุงุฑ 'nb' (ุนู Naive Bayes).

# #sys.argv[0] โ ูุงู ูุงู ุงุฌุฑุง: 'main.py'
# sys.argv[1] โ ุงููู ุขุฑฺฏููุงู ูุงู ูุฏู ูุง ุงุณุช: 'svm'

 # ฺุฑุง > 1ุ
# ฺูู ููุดู:
#     sys.argv[0] โ ูุงู ูุงู ูพุงุชูู ูุณุช.
#     ูพุณ ุงฺฏุฑ ููุท ุจุฑูุงูู ุงุฌุฑุง ุจุดู (ุจุฏูู ูฺ ุขุฑฺฏููุงู)ุ ุทูู ูุณุช sys.argv ููุท ฑ ูุณุช:
# ['main.py']
# ุจูุงุจุฑุงู:
#     ููุช ุทูู sys.argv ุจุดุชุฑ ุงุฒ 1 ุจุงุดูุ ุนู ุญุฏุงูู ฺฉ ุขุฑฺฏููุงู ุจุนุฏ ุงุฒ ุงุณู ูุงู ูู ูุงุฑุฏ ุดุฏู.


if model_name == "nb":
    from models.train_nb_model import train_model
    #  ุงฺฏุฑ ูุงู train_nb_model.py ูุฌูุฏ ูุฏุงุดุชู ุจุงุดู
    # ฺฉู ูพุดโูุฑุถ ูู ููููุ ุงููโููุช ุฏุฑ ุฒูุงู ุงุฌุฑุง ุงุฑูุฑ ูโฺฏุฑ (ูุซูุงู: ModuleNotFoundError).
elif model_name == "svm":
    from models.train_svm_model import train_model
elif model_name == "lr":
    from models.train_lr_model import train_model
else:
    raise ValueError("Unsupported model")


# ุชุงุจุน ุจุฑุง ุฎูุงูุฏู ุงููโูุง
# # ุชูุงู ูุงููุง ูุชู ุฑุง ูุฎูุงูุฏ ู ุฏุงุฎู ูุณุช ูุฑุฒุฏ
def load_emails_from_folder(folder):
    emails = []
    for filename in os.listdir(folder):
        path = os.path.join(folder, filename)
        with open(path, 'r', encoding='latin-1') as f:
            emails.append(f.read())
    return emails
# ุฎูุงูุฏู ุงููโูุง ุงุณูพู ู ูุนูููุงุฒ ูพูุดูโูุงุดุงู ุฏุฑ data/ ูโุฎูุงูุฏ.
spam_emails = load_emails_from_folder('../data/spam')
ham_emails = load_emails_from_folder('../data/easy_ham')

# ุณุงุฎุช ุฏุชุงูุฑู ู ุฏุงุฏู ูุจู ุจู ุงููุง
# # ุณุชูู text ุดุงูู ูุชู ุงููโูุง.
# # ุณุชูู label: ุนุฏุฏ ฑ ุจุฑุง ุงุณูพูุ ุนุฏุฏ ฐ ุจุฑุง ุงููโูุง ูุนููู.
df = pd.DataFrame({'text': spam_emails + ham_emails,
                   'label': [1]*len(spam_emails) + [0]*len(ham_emails)})
# #ูุฑุถ ฺฉู 3 ุงูู ุงุณูพู ุฏุงุฑู
# # ุงููโููุช len(spam_emails) ูโุดู 3. ุญุงูุง: [1] * 3
# # ูุณุงู ูโุดู ุจุง: [1, 1, 1]
# # # ุนู ุจุฑุง ณ ุงูู ุงุณูพูุ ณ ุนุฏุฏ ฑ ุชููุฏ ฺฉุฑุฏู. ููู ฺฉุงุฑ ุจุฑุง ุงููโูุง ูุนููู:
# # [0] * len(ham_emails)
# # ุฏุฑ ูุชุฌู:
# # y = [1, 1, 1, 0, 0, 0]

#ุชุจุฏู ูุญุชูุง ุงูู ุจู ุนุฏุฏ
vectorizer = TfidfVectorizer(stop_words='english', max_features=1000)
# #ูโฺฏูุฏ ฺฉู ฺฉููุงุช ุชููู (stop words) ุฒุจุงู ุงูฺฏูุณ ุฑุง ูุงุฏุฏู ุจฺฏุฑุฏ.ูุงููุฏ "the"ุ "a"ุ "is"ุ "are" ู ุบุฑู.
# ุจุง ุญุฐู ุงู ฺฉููุงุชุ ุชูุฑฺฉุฒ ูุฏู ุจุฑ ุฑู ฺฉููุงุช ูููโุชุฑ ุฎูุงูุฏ ุจูุฏ.
# #ููุท ฑฐฐฐ ฺฉูููโ ูููโุชุฑ ู ูพุฑุชฺฉุฑุงุฑุชุฑ ุฑุง ุงุฒ ุจู ุชูุงู ฺฉููุงุช ููุฌูุฏ ุฏุฑ ููู ุงููโูุง ูฺฏู ุฏุงุฑ ู ุจูู ุฑุง ูุงุฏุฏู ุจฺฏุฑ
X = vectorizer.fit_transform(df['text'])
#fit() ุนู: ุงุฒ ุฑู ุชูุงู ูุชูโูุงุ ฺฉููุงุช ูพุฑุชฺฉุฑุงุฑ ู ููู (ุทุจู TF-IDF) ุฑู ุงุฏ ุจฺฏุฑ
# ู ุจุฑุง ูุฑ ฺฉูููุ ฺฉ ุนุฏุฏ ุดุงุฎุต ูุดุฎุต ฺฉู.
# transform() ุนู: ุญุงูุง ุจุงู ูุฑ ูุชู ุฑู ุชุจุฏู ุจู ุจุฑุฏุงุฑ ุนุฏุฏ ฺฉูู ุจุง ุชูุฌู ุจู ุขู ฺุฒ ฺฉู ุฏุฑ fit() ุงุฏ ฺฏุฑูุชู.
y = df['label']

#ุฏุณุชู ุจูุฏ ุฏุชุง ุจู ุชุณุช ู ุชุฑู
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# ุขููุฒุด ูุฏู
model = train_model(X_train, y_train)

#  ูพุดโุจู ุฑู ุฏุงุฏูโูุง ุชุณุช ู ฺุงูพ ฺฏุฒุงุฑุด ุนููฺฉุฑุฏ ูุฏู.
y_pred = model.predict(X_test)
print(classification_report(y_test, y_pred))

#

# # ุงุทููุงู ุงุฒ ูุฌูุฏ ูููุฏุฑ models
os.makedirs('../models', exist_ok=True)

# ุฐุฎุฑู ูุฏู ู ุจุฑุฏุงุฑโุณุงุฒ
joblib.dump(model, f'../models/{model_name}_classifier.pkl')
joblib.dump(vectorizer, '../models/vectorizer.pkl')


"""
ููู:
1. ุจุฑุง ุงุฌุฑุง ุจู ูุงู main ูุฑูู
2. ุจุง ุชูุฌู ุจู ุงูฺฉู ุฎุฑูุฌ ฺู ูุฏู ุฑุง ูุฎูุงูู ฺฉ ุงุฒ ฺฉุฏูุง ุฒุฑ ุฑุง ุฏุฑ ุชุฑููุงู ูุฒูู
python main.py nb    
python main.py svm
python main.py lr

"""

#ูุฏูโูุง ูุฎุชูู ุดูุง ุฏุฑ ูพูุดู models/ ุฐุฎุฑู ุฎูุงููุฏ ุดุฏ.
# ุจู ุนููุงู ูุซุงูุ ุงฺฏุฑ ูุฏู SVM ุฑุง ุงูุชุฎุงุจ ฺฉูุฏุ ูุงู ูุฏู ุฐุฎุฑูโุดุฏู ุจู ูุงู svm_classifier.pkl ุฎูุงูุฏ ุจูุฏ.

#########################################
# ุชูุถุญ ุจุดุชุฑ ฺฉุฏูุง ุจุงูุง:

 # ฺุฑุง ุจุฑุง ุงูฺฉู ูุฏููุง ูุฎุชูู ุฑุง ุงููุฒุด ุฏุงุฏู ุจุงุดู ุงุฒ ุชฺฉู ฺฉุฏูุง ุจุงูุง ุฏุฑ ูู ุงุณุชูุงุฏู ูฺฉูู ู ูฺฏูุชู model_name = "nb"ุ
# ูุณููุงู ูโุชูุงู ุจููุณ:
# model_name = "nb"
# ู ฺฉุงุฑ ูู ูโฺฉูุฏ. ุงูุง ุงู ฺฉุงุฑ:
#     ุงุฌุฑุง ูุงู ุฑุง ูุญุฏูุฏ ุจู ฺฉ ูุฏู ุฎุงุต ูโฺฉูุฏ.
#     ุงฺฏุฑ ุจุฎูุงู ูุฏู ุฑุง ุนูุถ ฺฉูุ ุจุงุฏ ูุงุฑุฏ ฺฉุฏ ุดู ู ุฏุณุช ุชุบุฑ ุจุฏู.
# ุฏุฑ ุญุงูโฺฉู ุจุง sys.argvุ ุงุฒ ุจุฑูู ูุงู ูู ูโุชูุงู ูุฏู ุฑุง ุชุนู ฺฉู.
#ููููู ุงุฌุฑุง
    # python main.py nb     # ุงุฌุฑุง ูุฏู Naive Bayes
    # python main.py svm    # ุงุฌุฑุง ูุฏู SVM
    # python main.py lr     # ุงุฌุฑุง Logistic Regression



########################################
#
# # ๐น ููุงุด ฺูุฏ ูพุดโุจู ูุฏู ุฑู ุงููโูุง ุชุณุช ูุงูุน ุงุฒ ุฏุชุงุณุช
# #
# # print("\n๐ Sample predictions on test data:\n")
# #
# # # ุจุงุฒุงุจ ต ุงูู ู ููุงุด ูพุดโุจู ูุฏู
# # for i in range(5):
# #     email_text = df['text'].iloc[y_test.index[i]]
# #     true_label = y_test.iloc[i]
# #     predicted_label = y_pred[i]
# #
# #     print(f"Email {i+1}:")
# #     print(email_text[:200].replace('\n', ' '))  # ููุท ฒฐฐ ฺฉุงุฑุงฺฉุชุฑ ุงูู ุจุฑุง ููุงุด
# #     print("Prediction:", "SPAM โ" if predicted_label == 1 else "NOT SPAM โ")
# #     print("Actual:", "SPAM โ" if true_label == 1 else "NOT SPAM โ")
# #     print("-" * 60)
