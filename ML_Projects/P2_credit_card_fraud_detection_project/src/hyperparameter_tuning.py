
# # ูุฑุจูุท ุจู ฺฏุงู 10

# src/hyperparameter_tuning.py
import os
import pandas as pd
from sklearn.model_selection import GridSearchCV
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.svm import SVC

def tune_hyperparameters(X_train, y_train, output_dir="outputs", cv=3):
    """
    ุฑู ุณู ูุฏู ูุฎุชูู ุณุฑฺ ุดุจฺฉูโุง ุงูุฌุงู ูโุฏูุฏ ู
    ูุชุงุฌ ุฑุง ุฏุฑ ฺฉ CSV ุฐุฎุฑู ูโฺฉูุฏ.
    """
    os.makedirs(output_dir, exist_ok=True)

    search_space = {
        "Logistic Regression": {
            "estimator": LogisticRegression(max_iter=1000, class_weight='balanced', tol=0.01),
            # tol ุชุนู ูโฺฉูุฏ ฺฉู ุงู ูุฑุขูุฏ ุชฺฉุฑุงุฑ ฺู ุฒูุงู ูุชููู ุดูุฏ. ุงฺฏุฑ ุจูุจูุฏ ุฏุฑ ุชุงุจุน ูุฏู ุง ุชุบุฑ ุฏุฑ ูุฒูโูุง ูุฏู ุฏุฑ ฺฉ ฺฏุงูุ ุงุฒ ููุฏุงุฑ tol ฺฉูุชุฑ ุดูุฏุ ุงูฺฏูุฑุชู ุจูููโุณุงุฒ ูุฑุถ ูโฺฉูุฏ ฺฉู ุจู ููฺฏุฑุง (Convergence) ุฑุณุฏู ุงุณุช ู ูุชููู ูโุดูุฏ.
            # tol ุจุฒุฑฺฏุชุฑ (ูุซูุงู 0.001 ุง 0.01): ุนู ุงูฺฏูุฑุชู ูโุชูุงูุฏ ุฒูุฏุชุฑ ูุชููู ุดูุฏุ ุญุช ุงฺฏุฑ ูููุฒ ฺฉู ุฌุง ุจูุจูุฏ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ.


            "param_grid": {
                "C":       [0.1, 1.0, 10.0],
                # ูุซู SVMุ C ุฏุฑ Logistic Regression ูู ููุงู ุถุฑุจ regularization ุงุณุช.
                # C ุจุฒุฑฺฏโุชุฑ โ ูุฏู ุจุดุชุฑ ุฑู ุฏุฑุณุช ุชูุฑฺฉุฒ ูโฺฉูู
                # C ฺฉูฺฺฉโุชุฑ โ ูุฏู ุณุงุฏูโุชุฑ ู ูพุงุฏุงุฑุชุฑ

                "solver":  ["liblinear"]
            #     ูุดุฎุต ูโฺฉูู ฺฉู ุงูฺฏูุฑุชู ุนุฏุฏ ุจุฑุง ุจูููโุณุงุฒ ฺู ุจุงุดุฏ
            # ูุซูุงู ุงฺฏุฑ L1 Penalty ุจุฎูุงุ ุจุงุฏ liblinear ุงุณุชูุงุฏู ฺฉู. ูู ุงฺฏุฑ ุชุนุฏุงุฏ ูฺฺฏโูุง ุฒุงุฏ ุจุงุดูุ lbfgs ุณุฑุนโุชุฑู.
            #     ูุฏู GridSearch ุงูู ฺฉู ุชุณุช ฺฉูู ฺฉุฏูู solver ุจุง ฺฉุฏูู ููุฏุงุฑ Cุ ุจูุชุฑู ูุชุฌู ุฑู ูโุฏู
            # ูฺฉุชู ููู:
            #     ูููโ solverูุง ุจุง ูููโ ููุฏุงุฑูุง C ุง penaltyูุง ุณุงุฒฺฏุงุฑ ูุณุชู.
                # ุฏุฑ ุงู ูุซุงู ฺูู ููุท ุงุฒ L2 ุงุณุชูุงุฏู ูโฺฉู (ฺฉู ูพุดโูุฑุถู)ุ ูุฑ ุฏู solver (liblinear, lbfgs) ูุนุชุจุฑ ูุณุชู.
                # ุงฺฏุฑ ูุซูุงู ุงุฒ penalty='l1' ุงุณุชูุงุฏู ูโฺฉุฑุฏุ ุฏฺฏู lbfgs ูพุดุชุจุงู ููโฺฉุฑุฏ.
            }
            #  ูพุงุฑุงู ฺฏุฑุฏ ฺฉ ุฏฺฉุดูุฑ ุงุณุช ฺฉู ูโฺฏูุฏ: ยซุจุฑุง ูุฑ ูุงูพุฑูพุงุฑุงูุชุฑ ฺู ููุงุฏุฑ ุฑุง ุงูุชุญุงู ฺฉูยป.

        },
        "Random Forest": {
            "estimator": RandomForestClassifier(),
            "param_grid": {
                "n_estimators": [100, 200],
                "max_depth":    [10, 20, None]
            }
        #     ุฌูฺฏู ุชุตุงุฏู ุฏุฑุฎุช ูโุณุงุฒุฏุ ูพุณ ยซุชุนุฏุงุฏ ุฏุฑุฎุชโูุงยป (n_estimators) ู ยซุนูู ุฏุฑุฎุชยป (max_depth) ูุนูโุฏุงุฑ ุงุณุช.
        },
        "SVM": {
            "estimator": SVC(probability=True),
            # SVC(kernel="linear", probability=False) #ุฌุงฺฏุฒู ุฎุท ุจุงูุง ุดูุฏ ุจุฎุงุทุฑ ุทููุงู ุดุฏู ุฑููุฏ ุฎุฑูุฌ
            "param_grid": {
                "C":     [0.1, 1.0, 10.0],
                # #C ุถุฑุจู ูุนฺฉูุณู regularization ุงุณุช.
                #  ยซูุฏู ุฑุง ุจุง ุณู ุฏุฑุฌูโ ูุฎุชูู regularization ุงูุชุญุงู ฺฉู ุชุง ุจุจูู ฺฉุฏุงู ุจูุชุฑ ุฌูุงุจ ูโุฏูุฏ.ยป
                # ุจุฒุฑฺฏโุชุฑ ุดุฏู C โ ูุฌุงุฒุงุช ุฎุทุง ฺฉูุชุฑ โ ูุฏู ููุนุทูโุชุฑ (ุฑุณฺฉ overfit ุจุงูุงุชุฑ).
                # ฺฉูฺฺฉ ุดุฏู C โ ูุฌุงุฒุงุช ุฎุทุง ุจุดุชุฑ โ ูุฏู ุณุงุฏูโุชุฑ (ุฑุณฺฉ underfit).
                # ๐ GridSearch ุงู ณ ููุฏุงุฑ ุฑุง ุชุณุช ูโฺฉูุฏ ู ุจุง Cross Validation ูโุณูุฌุฏ ฺฉุฏุงู ููุฏุงุฑ C ุฏูุช ุง AUC ุจุดุชุฑ ูโุฏูุฏ.

                "kernel":["linear"]
                #ูุณุชู ุฎุท (Linear Kernel) ุณุงุฏูโุชุฑู ููุน ูุณุชู ุงุณุช. ุงู ูุณุชู ูุฑุถ ูโฺฉูุฏ ฺฉู ุฏุงุฏูโูุง ุดูุง ุงุฒ ุงุจุชุฏุง ุฏุฑ ูุถุง ูฺฺฏ (Feature Space) ุฎูุฏ ุจู ุตูุฑุช ุฎุท ูุงุจู ุฌุฏุงุณุงุฒ ูุณุชูุฏ.
            }
        #     SVM ุฎุท ูุฑุฒ ุง ฺฉุฑูู ูโุณุงุฒุฏุ ูพุณ ยซููุน ูุณุชูยป (kernel) ู ยซCยป ูููโุงูุฏ.
        }
    }


    all_results = []

    for name, cfg in search_space.items():
        print(f"๐  ุดุฑูุน GridSearch ุจุฑุง ยซ{name}ยป โฆ")

        X_sample = X_train.sample(n=5000, random_state=42)
        y_sample = y_train.loc[X_sample.index]
        # ุจู ุฌุง ุงุณุชูุงุฏู ุงุฒ ฺฉู X_train ฺฉู ุจุณุงุฑ ุจุฒุฑฺฏ ุงุณุชุ ูโุชูู ููุท ุจุฎุด ุงุฒ ุฏุงุฏูโูุง ุฑู ุจู GridSearch ุจุฏู. ุชุง ุฎุฑูุฌ ุฎู ุทููุงู ูุดูุฏ

        grid = GridSearchCV(
            estimator = cfg["estimator"],
            # ุจู GridSearchCV ูโฺฏูุฏ ฺฉู ุงุฒ ฺฉุฏุงู ูุฏู ูพุงู (ูุซูุงู LogisticRegression()) ุจุฑุง ุขููุฒุด ู ุงุฑุฒุงุจ ุงุณุชูุงุฏู ฺฉูุฏ.
            # ุงู ูุฏู ูููุฒ ุขููุฒุด ูุฏุฏู ู ููุท ุจู ุนููุงู ุงูฺฏู (template) ุจุฑุง GridSearchCV ุฏุงุฏู ูโุดูุฏ.

            param_grid= cfg["param_grid"],
            # ฺฉ ุฏฺฉุดูุฑ ุงุณุช ฺฉู ูโฺฏูุฏ: ยซุจุฑุง ูุฑ ูุงูพุฑูพุงุฑุงูุชุฑ ฺู ููุงุฏุฑ ุฑุง ุงูุชุญุงู ฺฉูยป.

            cv=cv,
            scoring="roc_auc",
            n_jobs=-1,            # ุงุณุชูุงุฏู ุงุฒ ูู ูุณุชูโูุง
            verbose=1             # ููุงุด ูพุดุฑูุช ุฑู ุชุฑููุงู
        )
        # ุงู ูุณู ุงุฒ ฺฉุฏ ฺฉ ุดุก ุงุฒ ฺฉูุงุณ GridSearchCV ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.
        # GridSearchCV ูุณุฆูู ุฌุณุชุฌู ุฌุงูุน ู ุณุณุชูุงุชฺฉ ุชูุงู ุชุฑฺฉุจุงุช ููฺฉู ูุงูพุฑูพุงุฑุงูุชุฑูุง ุฏุฑ param_grid ู ูพุฏุง ฺฉุฑุฏู ุจูุชุฑู ูุฏู ุงุณุช.

        # grid.fit(X_train, y_train)
        grid.fit(X_sample, y_sample)
        # ุงุฒ ุชูุงู ุฏุงุฏู ูุง ุงุณุชูุงุฏู ููฺฉูู ุชุง ุฒูุงู ุฎุฑูุฌ ฺฉูุชุฑ ุดูุฏ

        print(f"โ  ุจูุชุฑู ูพุงุฑุงูุชุฑูุง {name}: {grid.best_params_}")
        print(f"๐  ุจูุชุฑู ROCโAUC: {grid.best_score_:.3f}\n")

        all_results.append({
            "Model":         name,
            "Best Params":   grid.best_params_,
            "Best ROC AUC":  grid.best_score_
        })

        # ุงฺฏุฑ ุจุฎูุงู ุจูุชุฑู ูุฏู ุฑุง ุฐุฎุฑู ฺฉู:
        best_path = os.path.join(output_dir, f"best_{name.replace(' ','_')}.joblib")
        import joblib; joblib.dump(grid.best_estimator_, best_path)

    # ุฐุฎุฑ ุชูุงู ูุชุงุฌ ุฏุฑ CSV
    df = pd.DataFrame(all_results)
    csv_path = os.path.join(output_dir, "hyperparam_results.csv")
    df.to_csv(csv_path, index=False)
    print(f"๐  ูุชุงุฌ ฺฉุงูู ุฏุฑ ยซ{csv_path}ยป ุฐุฎุฑู ุดุฏ.")
