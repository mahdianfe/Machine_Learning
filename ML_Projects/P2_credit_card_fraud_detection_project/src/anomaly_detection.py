#
# # ุฏุฑ ุงู ูุงูุ ุชุดุฎุต ูุงููุฌุงุฑโูุง ุจุง ุงูฺฏูุฑุชู Isolation Forest ุงูุฌุงู ูโุดูุฏ.
# #
# # ุชุดุฎุต ูุงููุฌุงุฑ (Anomaly Detection) ฺฉู ุจู ุขู ุชุดุฎุต ูพุฑุช (Outlier Detection) ูุฒ ฺฏูุชู ูโุดูุฏุ
# ูุฑุขูุฏ ุดูุงุณุง ููุงุฑุฏ ุฏุฑ ฺฉ ูุฌููุนู ุฏุงุฏู ุงุณุช ฺฉู ุจุง ุฑูุชุงุฑ ููุฑุฏ ุงูุชุธุงุฑ ุง ุงูฺฏููุง ุบุงูุจ ุฏุงุฏูโูุง ุชูุงูุช ูุงุจู ุชูุฌู ุฏุงุฑูุฏ.
# ุงู ููุงุฑุฏ ุบุฑุนุงุฏ ูโุชูุงููุฏ ูุดุงูโุฏููุฏู ุชููุจุ ุฎุทุงุ ุฑูุฏุงุฏูุง ูุงุฏุฑ ุง ููุงุฑุฏ ุบุฑููุชุธุฑู ุจุงุดูุฏ ฺฉู ูุงุฒ ุจู ุจุฑุฑุณ ุฏุงุฑูุฏ.
#
# # ุนุฏุฏ ฺฉู ุฏุฑ ุฎุฑูุฌ ููุงุด ุฏุงุฏู ุฎูุงูุฏ ุดุฏ ูุดุงูโุฏููุฏู ุชุนุฏุงุฏ ูุงููุฌุงุฑโูุง (ููุงุฑุฏ ุบุฑุนุงุฏ) ุดูุงุณุง ุดุฏู ุชูุณุท ุงูฺฏูุฑุชู Isolation Forest ุฏุฑ ูุฌููุนู ุฏุงุฏู X_test ุงุณุช.


# ุฎุฑุ Anomaly Detection (ุชุดุฎุต ูุงููุฌุงุฑ)ุ ูุงููุฏ ุงูฺฏูุฑุชู Isolation Forestุ ููุงููุฏ ุชุงุจุน ุถุฑุฑ ุง ุจูููโุณุงุฒ ุง ฺฏุฑุงุฏุงู ูุณุช.
#
# ุงููุง ููุงูู ูุฑุจูุท ุจู ูุธุงู (Tasks) ู ุงูฺฏูุฑุชูโูุง ูุชูุงูุช ุฏุฑ ุงุฏฺฏุฑ ูุงุดู ูุณุชูุฏ:
#
#     ุชุดุฎุต ูุงููุฌุงุฑ (Anomaly Detection):
#
#         ุงู ฺฉ ูุธูู ุฏุฑ ุงุฏฺฏุฑ ูุงุดู ุงุณุช ฺฉู ุงุบูุจ ุฒุฑูุฌููุนู ุงุฏฺฏุฑ ุจุฏูู ูุธุงุฑุช (Unsupervised Learning) ูุฑุงุฑ ูโฺฏุฑุฏ.
#
#         ูุฏู ุขู ุดูุงุณุง ููุงุท ุฏุงุฏูโุง ุงุณุช ฺฉู ุจู ุทูุฑ ูุงุจู ุชูุฌู ุงุฒ ุงูฺฏู ุงุตู ุง ุงฺฉุซุฑุช ุฏุงุฏูโูุง ููุญุฑู ูโุดููุฏ (ุนู "ูุงููุฌุงุฑ" ุง "ูพุฑุช").
#
#         Isolation Forest ฺฉ ุงูฺฏูุฑุชู ุจุฑุง ุงู ฺฉุงุฑ ุงุณุช. ุงู ุงูฺฏูุฑุชู ุจุง ุณุงุฎุช ุฏุฑุฎุชุงู ุชุตูู (ูุงููุฏ Random Forest) ู ุงูุฏุงุฒูโฺฏุฑ "ุนูู" ููุฑุฏ ูุงุฒ ุจุฑุง ุฌุฏุงุณุงุฒ ฺฉ ููุทูุ ูุงููุฌุงุฑโูุง ุฑุง ุดูุงุณุง ูโฺฉูุฏ. ููุงุท ฺฉู ุณุฑุนโุชุฑ ุฌุฏุง ูโุดููุฏุ ุจู ุงุญุชูุงู ุฒุงุฏ ูุงููุฌุงุฑ ูุณุชูุฏ.
#
#         ูฺฺฏ ุจุงุฑุฒ: ุฏุฑ Anomaly Detectionุ ูุนูููุงู ุจุฑฺุณุจโูุง ูุงูุน ุจุฑุง ูุงููุฌุงุฑโูุง ูุฏุงุฑู (ุจุฏูู ูุธุงุฑุช ุงุณุช)ุ ุจูุงุจุฑุงู ููโุชูุงูู ฺฉ loss ุฑุง ุจุง ููุงุณู ูพุดโุจู ู ูุงูุนุช ูุญุงุณุจู ฺฉูู ู ุณูพุณ ุงุฒ ฺฏุฑุงุฏุงู ุจุฑุง ุจูโุฑูุฒุฑุณุงู ูพุงุฑุงูุชุฑูุง ูุฏู ุงุณุชูุงุฏู ฺฉูู.




# Anomaly Detection ูุฎุตูุต ูุฏููุง ูุธุงุฑุช ูุดุฏู ุงุณุช ุงูุง ุณูุงู ูพุด ูุงุฏ ฺฉู ฺุฑุง 
# ฺุฑุง Anomaly Detection ุฏุฑ ูพุฑูฺูโุง ุจุง ูุฏูโูุง ูุธุงุฑุชโุดุฏู ุงุณุชูุงุฏู ูโุดูุฏุ (ุจูโูฺู ุฏุฑ ุชุดุฎุต ุชููุจ)
#
# ูพุฑูฺูโูุง ูุงููุฏ ุชุดุฎุต ุชููุจ ฺฉุงุฑุช ุงุนุชุจุงุฑ ุฏุงุฑุง ูฺฺฏโูุง ุฎุงุต ูุณุชูุฏ ฺฉู ุงุณุชูุงุฏู ุงุฒ ุฑูฺฉุฑุฏูุง ุชุฑฺฉุจ (ูุจุฑุฏ) ุฑุง ุจุณุงุฑ ููุฏ ูโฺฉูุฏ:
#
#     ุนุฏู ุชุนุงุฏู ุฏุงุฏูโุง ุดุฏุฏ (Extreme Data Imbalance):
#
#         ุฏุฑ ุฏุงุฏูโูุง ุชููุจุ ุชุนุฏุงุฏ ุชุฑุงฺฉูุดโูุง ุนุงุฏ ุจุณุงุฑ ุจุณุงุฑ ุจุดุชุฑ ุงุฒ ุชุฑุงฺฉูุดโูุง ุชููุจ ุงุณุช (ูุซูุงู 99.9% ุนุงุฏ ุฏุฑ ููุงุจู 0.1% ุชููุจ).
#
#         ูุฏูโูุง ูุธุงุฑุชโุดุฏู ฺฉูุงุณฺฉ (ูุงููุฏ Logistic Regression, Random Forest, SVM) ุจุฑุง ฺฉุงุฑ ุจุง ุฏุงุฏูโูุง ูุงูุชุนุงุฏู ฺุงูุดโูุง ุฏุงุฑูุฏ ู ููฺฉู ุงุณุช ฺฉูุงุณ ุงููุช (ุชููุจ) ุฑุง ูุงุฏุฏู ุจฺฏุฑูุฏุ ุฒุฑุง ุจูููโุณุงุฒ ุขูโูุง ุจุฑ ุฑู ฺฉุงูุด ุฎุทุง ฺฉู ุงุณุช ู ูู ูุฒููุงู ุชุดุฎุต ฺฉูุงุณ ุงููุช.
#
#         ููุด Anomaly Detection: ุงูฺฏูุฑุชูโูุง ุชุดุฎุต ูุงููุฌุงุฑุ ูุงููุฏ Isolation Forestุ ุจู ุทูุฑ ุฐุงุช ุจุฑุง ุดูุงุณุง ููุงุท "ุบุฑุนุงุฏ" ุทุฑุงุญ ุดุฏูโุงูุฏุ ุญุช ุงฺฏุฑ ุชุนุฏุงุฏ ุขูโูุง ุจุณุงุฑ ฺฉู ุจุงุดุฏ. ุขูโูุง ุณุน ูโฺฉููุฏ ุงูฺฏููุง "ุนุงุฏ" ุฑุง ุงุฏ ุจฺฏุฑูุฏ ู ูุฑ ฺุฒ ุฑุง ฺฉู ุจู ูุถูุญ ุงุฒ ุงู ุงูฺฏู ุฎุงุฑุฌ ุงุณุชุ ุจู ุนููุงู ูุงููุฌุงุฑ ุนูุงูุชโฺฏุฐุงุฑ ฺฉููุฏ.
#
#     ุงูฺฏููุง ุชููุจ ุฌุฏุฏ ู ูุงุดูุงุฎุชู (Evolving/Novel Fraud Patterns):
#
#         ฺฉูุงูุจุฑุฏุงุฑุงู ุฏุงุฆูุงู ุฑูุดโูุง ุฎูุฏ ุฑุง ุชุบุฑ ูโุฏููุฏ. ูุฏูโูุง ูุธุงุฑุชโุดุฏู ููุท ูโุชูุงููุฏ ุงูฺฏููุง ุชููุจ ุฑุง ฺฉู ูุจูุงู ุฏุฑ ุฏุงุฏูโูุง ุขููุฒุด ุฏุฏูโุงูุฏุ ุดูุงุณุง ฺฉููุฏ.
#
#         ููุด Anomaly Detection: ุงู ุงูฺฏูุฑุชูโูุง ูโุชูุงููุฏ ุชุฑุงฺฉูุดโูุง ุฑุง ฺฉู ุจุง ูฺ ฺฉ ุงุฒ ุงูฺฏููุง ุนุงุฏ ุง ุชููุจ ุดูุงุฎุชูโุดุฏู (ููุฌูุฏ ุฏุฑ ุฏุงุฏูโูุง ุขููุฒุด) ูุทุงุจูุช ูุฏุงุฑูุฏุ ูพุฑฺูโฺฏุฐุงุฑ ฺฉููุฏ. ุงู ุจู ฺฉุดู ุงูฺฏููุง ุชููุจ ฺฉุงููุงู ุฌุฏุฏ ฺฉูฺฉ ูโฺฉูุฏ ฺฉู ูุฏูโูุง ูุธุงุฑุชโุดุฏู ูุฑฺฏุฒ ุขูโูุง ุฑุง "ุงุฏ ูฺฏุฑูุชูโุงูุฏ".
#
#     ุฑูฺฉุฑุฏ ูุจุฑุฏ (Hybrid Approach) ู ุชฺฉูู:
#
#         ุฏุฑ ุจุณุงุฑ ุงุฒ ููุงุฑุฏุ Anomaly Detection ุจู ุนููุงู ฺฉ ูุฑุญูู ูฺฉูู ุจุฑุง ูุฏูโูุง ูุธุงุฑุชโุดุฏู ุงุณุชูุงุฏู ูโุดูุฏ. ุงู ูโุชูุงูุฏ ุจู ฺูุฏ ุดฺฉู ุจุงุดุฏ:
#
#             Feature Engineering: ุงูุชุงุฒ ูุงููุฌุงุฑ (anomaly score) ฺฉู ุชูุณุท ฺฉ ุงูฺฏูุฑุชู Anomaly Detection ุชููุฏ ูโุดูุฏ (ูุซูุงู scores ุฏุฑ detect_anomalies ุจุฑุง Isolation Forest)ุ ูโุชูุงูุฏ ุจู ุนููุงู ฺฉ ูฺฺฏ ุฌุฏุฏ ุจู ุฏุงุฏูโูุง ุงุถุงูู ุดูุฏ ู ุณูพุณ ุจู ูุฏูโูุง ูุธุงุฑุชโุดุฏู (Logistic Regression, Random Forest, SVM) ุฏุงุฏู ุดูุฏ. ุงู ุจู ูุฏูโูุง ูุธุงุฑุชโุดุฏู ฺฉูฺฉ ูโฺฉูุฏ ุชุง ุงุฒ ุงุทูุงุนุงุช ูุฑุจูุท ุจู "ุบุฑุนุงุฏ ุจูุฏู" ุชุฑุงฺฉูุดโูุง ูุฒ ุงุณุชูุงุฏู ฺฉููุฏ.
#
#             Multi-layered Detection: ุงุจุชุฏุง ูุฏูโูุง ูุธุงุฑุชโุดุฏู ูพุดโุจูโูุง ุฎูุฏ ุฑุง ุงูุฌุงู ูโุฏููุฏ. ุณูพุณุ ุงูฺฏูุฑุชูโูุง Anomaly Detection ุชุฑุงฺฉูุดโูุง ุฑุง ฺฉู ุชูุณุท ูุฏูโูุง ูุธุงุฑุชโุดุฏู ุจู ุนููุงู "ุนุงุฏ" ุทุจููโุจูุฏ ุดุฏูโุงูุฏ ุงูุง ุฑูุชุงุฑ ูุดฺฉูฺฉ ุฏุงุฑูุฏุ ุจุฑุฑุณ ูโฺฉููุฏ ุชุง ุงุฒ ูุดุช ุชููุจโูุง ูพููุงู ุฌููฺฏุฑ ุดูุฏ.
#
#             Semisupervised Learning: ุฏุฑ ุจุฑุฎ ููุงุฑุฏุ Anomaly Detection ูโุชูุงูุฏ ุฏุฑ ฺฉ ุณูุงุฑู ูููโูุธุงุฑุชโุดุฏู ุงุณุชูุงุฏู ุดูุฏุ ุฌุง ฺฉู ููุท ุจุฑฺุณุจโูุง "ุนุงุฏ" ุฏุฑ ุฏุณุชุฑุณ ูุณุชูุฏุ ู ูุฑ ฺุฒ ฺฉู ุงุฒ ุงู ุญุงูุช ููุญุฑู ุดูุฏุ "ูุงููุฌุงุฑ" ุฏุฑ ูุธุฑ ฺฏุฑูุชู ูโุดูุฏ.



# ูุฑุจูุท ุจู ฺฏุงู ุงุฒุฏูู
# src/anomaly_detection.py

from sklearn.ensemble import IsolationForest
import numpy as np
import pandas as pd


def detect_anomalies(X, model=None, threshold=0.1):
    """
    ุงฺฏุฑ ูุฏู ุฏุงุฏู ูุดูุฏุ ุงุฒ Isolation Forest ุงุณุชูุงุฏู ูโุดูุฏ.
    ุงฺฏุฑ ูุฏู ุฏุงุฏู ุดูุฏุ ูุงููุฌุงุฑโูุง ุจุฑ ุงุณุงุณ ุงุญุชูุงู ุง ุจุฑฺุณุจ ุชุนู ูโุดููุฏ.

    ูุฑูุฏ:
        X: ูฺฺฏโูุง ุชุณุช
        model: ฺฉ ุงุฒ ูุฏูโูุง ุขููุฒุดโุฏุงุฏูโุดุฏู (ุง None)
        threshold: ุขุณุชุงููโุง ุจุฑุง ุชุนู ูุงููุฌุงุฑ ุงุฒ ุฑู ุงุญุชูุงู

    ุฎุฑูุฌ:
        DataFrame ุจุง ุณุชููโูุง ['Index', 'Anomaly', 'Score']
    """
    if model is None:
        iso_forest = IsolationForest(contamination=0.01, random_state=42)
        scores = -iso_forest.decision_function(X)  # ููุฑู ูุงููุฌุงุฑ (ุจุฒุฑฺฏุชุฑ โ ูุงููุฌุงุฑุชุฑ)
        preds = iso_forest.predict(X)
        is_anomaly = (preds == -1).astype(int)

        print(f"๐ Anomalies detected by IsolationForest: {np.sum(is_anomaly)}")

    else:
        if hasattr(model, "predict_proba"):
            probs = model.predict_proba(X)[:, 1]  # ุงุญุชูุงู ฺฉูุงุณ ฑ
            is_anomaly = (probs < threshold).astype(int)
            scores = probs  # ุงูุฌุง score ููุงู ุงุญุชูุงู ุงุณุช

            print(f"๐ Anomalies detected by {model.__class__.__name__}: {np.sum(is_anomaly)} (threshold={threshold})")

        else:
            preds = model.predict(X)
            is_anomaly = (preds == 1).astype(int)
            scores = preds  # ุฏุฑ ุงูุฌุง score ูููู ุจุฑฺุณุจู ฺูู probability ูุฏุงุฑู

            print(f"โ๏ธ Model {model.__class__.__name__} does not support predict_proba(). Using label==1 as anomaly.")

    results_df = pd.DataFrame({
        "Index": np.arange(len(X)),
        "Anomaly": is_anomaly,
        "Score": scores
    })

    return results_df
